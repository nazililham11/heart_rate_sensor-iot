var app=new Vue({el:"#app",data(){return{activeTab:"device",xVal:1,dataLength:3e3,dps:[],chart:null,graphSource:"",fileDataset:[],dvc_dataset:[],dvc_recordDurationLimit:10,dvc_signalFreq:100,dvc_rValueThreshold:850,dvc_rrDiffThreshold:50,signalFreq:360,rValueThreshold:1020,rrDiffThreshold:50,fileTempData:null,dataColumn:[],selectedColumn:0,selectedFileName:"",selectedColumnName:"",avgBpm:0,diff:0,minRR:0,maxRR:0,avgRrMs:0,isPredicted:!1,isRecordingData:!1,connection_status:"disconnected",connection_timeout:null,socket:null}},methods:{initChart(){this.chart=new CanvasJS.Chart("chart",{data:[{type:"line",dataPoints:this.dps}],animationEnabled:!0,zoomEnabled:!0})},insertChart(e){for(var t=0;t<e.length;t++)this.dps.push({x:this.xVal,y:e[t]}),this.xVal++,this.dps.length>this.dataLength&&this.dps.shift()},resetChart(){for(this.xVal=1;0<this.dps.length;)this.dps.pop();this.chart.render()},fileInputChanged(e){var t=new FileReader;t.onload=()=>this.fileOnLoad(t),"text/csv"!==e.target.files[0].type?(console.log("wrong file types"),alert("wrong file types"),this.$refs.inputFile.value=null):(t.readAsText(e.target.files[0]),this.selectedFileName=e.target.files[0].name)},selectDataPressed(){const t=[],s=this.selectedColumn;Array.isArray(this.fileTempData)&&Array.isArray(this.fileTempData[0])&&this.selectedColumn<this.fileTempData[0].length&&(this.selectedColumnName=this.fileTempData[0][s],this.graphSource=this.selectedFileName+" - "+this.selectedColumnName,this.fileTempData.forEach(e=>{e=parseInt(e[s]);e&&t.push(e)})),0<(this.fileDataset=t).length&&(this.dataLength=t.length,this.resetChart(),this.insertChart(t),this.chart.render())},proceedBtnPressed(){if(this.resetResult(),this.checkInputField())console.log("wrong input"),alert("wrong input");else{let e;if("file"===this.activeTab){if(this.fileDataset.length<1)return;e=this.getResult(this.fileDataset,this.fileConfig)}else{if(this.dvc_dataset.length<1)return;e=this.getResult(this.dvc_dataset,this.deviceConfig)}this.avgBpm=e.avgBpm,this.diff=e.diff,this.minRR=e.minRR,this.maxRR=e.maxRR,this.avgRrMs=e.avgRrMs,this.rrMsStdDev=e.rrMsStdDev,this.isPredicted=!0,console.log("result",e)}},resetBtnPressed(){this.resetChart(),this.dvc_dataset=[],this.fileDataset=[],this.selectedColumn=0,this.dataColumn=[],this.fileTempData=null,this.selectedFileName="",this.selectedColumnName="",this.graphSource="",this.resetResult(),this.$refs.inputFile.value=null},recordBtnPressed(){this.xVal=1,this.resetChart(),this.dvc_dataset=[],this.isRecordingData=!0,this.dataLength=this.deviceConfig.datasetLimit,console.log("recording start")},doneRecording(){this.isRecordingData=!1,this.graphSource="Hardware",console.log("recording end")},checkInputField(){var e=this.deviceConfig,t=this.fileConfig;return"file"===this.activeTab?isNaN(t.signalFreq)||isNaN(t.rValueThreshold)||isNaN(t.rrDiffThreshold):isNaN(e.signalFreq)||isNaN(e.rValueThreshold)||isNaN(e.rrDiffThreshold)},getResult(t,s){var i,a,r,n;const h=e=>Math.round(100*(e+Number.EPSILON))/100,l=[];for(let e=0;e<t.length;e++)t[e]>s.rValueThreshold&&(i=e,a=s.samplingDiff,n=r=void 0,r=t.length,a={startIndex:n=i-a<0?0:i-a,endIndex:i=r<=i+a?r:i+a,dataLength:r,result:t.slice(n,i)},r=a.result,n=void 0,i={maxValue:n=Math.max.apply(null,r),index:r.indexOf(n)},l.push(i.index+a.startIndex),e=a.endIndex);const d=[];for(let e=1;e<l.length;e++)d.push(Math.abs(l[e]-l[e-1]));const o=[];d.forEach(e=>o.push(h(e*s.msBetweenSignal)));let c=0;o.forEach(e=>c+=e),c=h(c/o.length);var e=Math.min.apply(null,o),g=Math.max.apply(null,o),f=h(this.getStandardDeviation(o));const u=[];let m=0;o.forEach(e=>u.push(h(6e4/e))),u.forEach(e=>m+=e);var p=h(m/u.length);const v=[];if(1<o.length)for(let e=1;e<o.length;e++)v.push(h(Math.abs(o[e]-o[e-1])));var R=v.filter(e=>e>s.rrDiffThreshold),D=100*h(R.length/o.length);return{rIndexes:l,rrMs:o,rrDiff:v,filteredRRDiff:R,diff:D,bpm:u,avgBpm:p,avgRrMs:c,minRR:e,maxRR:g,rrMsStdDev:f,cfg:s}},resetResult(){this.avgBpm=0,this.diff=0,this.minRR=0,this.maxRR=0,this.avgRrMs=0,this.isPredicted=!1},getStandardDeviation(e){if(!Array.isArray(e)||e.length<1)return 0;var t=e.length;const s=e.reduce((e,t)=>e+t)/t;return Math.sqrt(e.map(e=>Math.pow(e-s,2)).reduce((e,t)=>e+t)/t)},initWebsocket(){this.socket=new ReconnectingWebSocket("ws://192.168.43.222:81/",null,{debug:!1,reconnectInterval:2e3,maxReconnectInterval:1e4,timeoutInterval:2e3}),this.socket.onmessage=e=>{clearTimeout(this.connection_timeout),this.connection_timeout=setTimeout(()=>{this.connection_status="disconnected"},5e3),this.connection_status="connected",this.isRecordingData&&this.processReceivedCommand(e)},this.socket.onconnecting=e=>{this.connection_status="connecting"}},processReceivedCommand(e){const t=JSON.parse(e.data).dataSample;Array.isArray(t)&&0<t.length&&(t.forEach(e=>{this.dvc_dataset.length<this.deviceConfig.datasetLimit&&this.dvc_dataset.push(e)}),this.insertChart(t),this.chart.render()),this.dvc_dataset.length>=this.deviceConfig.datasetLimit&&this.doneRecording()},fileOnLoad(e){const t=this.CSVToArray(e.result);Array.isArray(t)&&Array.isArray(t[0])&&(this.fileTempData=Object.freeze(t),this.dataColumn=[],this.selectedColumn=0,t[0].forEach(e=>this.dataColumn.push(e)),this.resetChart())},CSVToArray(e,t){t=t||",";for(var s=new RegExp("(\\"+t+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+t+"\\r\\n]*))","gi"),i=[[]],a=null;a=s.exec(e);){var r=a[1];r.length&&r!==t&&i.push([]),r=a[2]?a[2].replace(new RegExp('""',"g"),'"'):a[3],i[i.length-1].push(r)}return i}},computed:{fileConfig(){var e=parseInt(this.rValueThreshold),t=parseInt(this.rrDiffThreshold),s=parseInt(this.signalFreq);return{rValueThreshold:e,rrDiffThreshold:t,samplingDiff:Math.ceil(10*s/100),signalFreq:s,msBetweenSignal:1e3/s,datasetLength:this.fileDataset.length}},deviceConfig(){var e=parseInt(this.dvc_signalFreq),t=parseInt(this.dvc_rValueThreshold),s=parseInt(this.dvc_rrDiffThreshold),i=parseInt(this.dvc_recordDurationLimit);return{rValueThreshold:t,rrDiffThreshold:s,samplingDiff:Math.ceil(10*e/100),signalFreq:e,msBetweenSignal:1e3/e,datasetLimit:i*e,datasetLength:this.dvc_dataset.length}},predictResult(){var e="file"===this.activeTab?this.fileConfig:this.deviceConfig;return{rValueThreshold:e.rValueThreshold,avgBpm:this.avgBpm,signalFreq:e.signalFreq,dataDuration:e.datasetLength*e.msBetweenSignal/1e3,datasetLength:e.datasetLength,minRR:this.minRR,maxRR:this.maxRR,minMaxDiff:Math.abs(this.maxRR-this.minRR),avgRrMs:this.avgRrMs,rrMsStdDev:this.rrMsStdDev,diff:this.diff}},recordProgress(){var e=this.dvc_dataset.length,t=this.deviceConfig.datasetLimit;return Math.ceil(e/t*100)}},mounted(){this.initChart(),this.initWebsocket(),this.resetBtnPressed()}});